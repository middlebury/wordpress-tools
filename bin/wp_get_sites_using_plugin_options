#!/usr/bin/env php
<?php

$usage = <<<END
Usage:
	$argv[0] <config-section> <plugin_name> <regex>

	<plugin_name> Can be just the plugin name or the path to the
	       plugin directory. E.g.
		       subscribe2
		   or
		       plugins/subscribe2/

	<key-regex> A regular expression that will match options keys used by
	        the plugin. The wp_*_options.option_key field is searched.

	<value-regex> A regular expression that will match options values used by
	        the plugin. The wp_*_options.option_value field is searched.

Example, look for non-empty values:
	$argv[0] midd wp-google-fonts 'googlefonts_options' '.+'


END;

if (!isset($argv[4]) || !strlen(trim($argv[4])) || !isset($argv[3]) || !strlen(trim($argv[3])) || !isset($argv[2]) || !strlen(trim($argv[2])) || $argv[1] == '-h' || $argv[1] == '--help') {
  fwrite(STDERR, $usage);
  exit(1);
}

$config_section = $argv[1];
if (empty($config_section) || $argc > 5) {
	fwrite(STDERR, $usage);
	exit(1);
}

$ini = parse_ini_file(dirname(dirname(__FILE__)).'/config.ini', true);
global $dev_uri, $prod_uri;
if (empty($ini[$config_section])) {
	fwrite(STDERR, $usage);
	fwrite(STDERR, "Config section, [$config_section], was not found in the ini file.");
	exit(1);
}


$plugin = basename(rtrim($argv[2], '/'));

$keyRegex = trim($argv[3]);
$valRegex = trim($argv[4]);

// require('/home/wordpress/websites/blogs/wp-config.php');

$prod_db_host = $ini[$config_section]['prod_db_host'];
if (empty($prod_db_host)) {
	fwrite(STDERR, $usage);
	fwrite(STDERR, "config.ini [$config_section] must have prod_db_host defined.");
	exit(2);
}
$prod_db_database = $ini[$config_section]['prod_db_database'];
if (empty($prod_db_database)) {
	fwrite(STDERR, $usage);
	fwrite(STDERR, "config.ini [$config_section] must have prod_db_database defined.");
	exit(2);
}
$prod_db_user = $ini[$config_section]['prod_db_user'];
if (empty($prod_db_user)) {
	fwrite(STDERR, $usage);
	fwrite(STDERR, "config.ini [$config_section] must have prod_db_user defined.");
	exit(2);
}
$prod_db_password = $ini[$config_section]['prod_db_password'];
if (empty($prod_db_password)) {
	fwrite(STDERR, $usage);
	fwrite(STDERR, "config.ini [$config_section] must have prod_db_password defined.");
	exit(2);
}


$db = new mysqli($prod_db_host, $prod_db_user, $prod_db_password, $prod_db_database);

$tableRes = $db->query('SHOW TABLES;');
while($row = $tableRes->fetch_row()) {
	$table = $row[0];
	if (preg_match('/^wp_?([0-9]*)_options$/', $table, $matches)) {
		$siteId = $matches[1];
		$usingRes = $db->query("select option_name, option_value from ".$table." where option_name='active_plugins' AND option_value REGEXP '(\"|/)".$db->escape_string($plugin)."(/|\\.php)';");
		$using = $usingRes->num_rows;
		$usingRes->free();
		if ($using) {
			$nameRes = $db->query("select option_value from ".$table." where option_name = 'home';");
			$nameRow = $nameRes->fetch_row();
			$url = $nameRow[0];
			$nameRes->free();

			$nameRes = $db->query("select option_value from ".$table." where option_name = 'admin_email';");
			$nameRow = $nameRes->fetch_row();
			$email = $nameRow[0];
			$nameRes->free();

			print $siteId."\t".$url."\t".$email."\tText seen in:";

			// look through postmeta for usage.
			$textExists = FALSE;
			// print "\nSELECT * FROM wp_".$siteId."_options WHERE option_key REGEXP '".preg_quote($keyRegex)."' AND option_value REGEXP '".preg_quote($valRegex)."';\n";
			$textRes = $db->query("SELECT * FROM wp_".$siteId."_options WHERE option_name REGEXP '".preg_quote($keyRegex)."' AND option_value REGEXP '".preg_quote($valRegex)."'");
			while($optionRow = $textRes->fetch_assoc()) {
				$textExists = TRUE;
				print "\n\t".$optionRow['option_id']
					."\t".$optionRow['option_name']
					."\t".$optionRow['option_value'];
			}
			$textRes->free();
			if ($textExists) {
				print "\n";
			} else {
				print " None\n";
			}
		}
	}
}
$tableRes->free();

$db->close();
